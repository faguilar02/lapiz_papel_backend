version: "3.8"

services:
  xades-signer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: xades-signer
    ports:
      - "8080:8080" # Puerto necesario para conectar desde NestJS en desarrollo
    environment:
      - JAVA_OPTS=-Xmx1g -XX:+UseG1GC
      - SERVER_PORT=8080
      - LOGGING_LEVEL_ROOT=INFO
      - LOGGING_LEVEL_COM_SUNAT_XADESSIGNER=DEBUG
      # Variables de ejemplo para certificados por alias
      # - CERT_PROD_PATH=/app/certs/certificado_prod.p12
      # - CERT_PROD_PASSWORD=password_seguro
      # - CERT_TEST_PATH=/app/certs/certificado_test.p12
      # - CERT_TEST_PASSWORD=password_test
    # volumes:
    # Montar directorio de certificados (para modo alias)
    # - ./certs:/app/certs:ro
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.sunat.service=xades-signer"
      - "com.sunat.version=1.0.0"
      - "com.sunat.description=XAdES-BES signature service for UBL documents - Internal use only"
    networks:
      - xades-internal

# Red interna para comunicaci√≥n segura entre servicios
networks:
  xades-internal:
    name: xades-network
    driver: bridge
    internal: true # Red completamente interna, sin acceso a Internet
